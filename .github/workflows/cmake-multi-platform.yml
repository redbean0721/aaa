name: CMake Multi-Platform Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        arch: [x64, arm64]
        build_type: [Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build directory
        id: vars
        shell: bash
        run: |
          echo "BUILD_DIR=${GITHUB_WORKSPACE}/build" >> "$GITHUB_OUTPUT"

      # =======================
      # Linux dependencies
      # =======================
      - name: Setup Linux dependencies
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            g++-aarch64-linux-gnu

      # =======================
      # Windows dependencies
      # =======================
      - name: Setup Windows MinGW
        if: runner.os == 'Windows'
        shell: bash
        run: |
          choco install mingw -y
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> "$GITHUB_PATH"

      # =======================
      # Configure CMake
      # =======================
      - name: Configure CMake
        shell: bash
        run: |
          mkdir -p "${{ steps.vars.outputs.BUILD_DIR }}"
          cd "${{ steps.vars.outputs.BUILD_DIR }}"

          if [[ "${{ runner.os }}" == "Linux" && "${{ matrix.arch }}" == "arm64" ]]; then
            printf '%s\n' \
              'set(CMAKE_SYSTEM_NAME Linux)' \
              'set(CMAKE_SYSTEM_PROCESSOR aarch64)' \
              'set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)' \
              'set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)' \
              > aarch64-toolchain.cmake

            cmake "${{ github.workspace }}" \
              -DCMAKE_TOOLCHAIN_FILE="$(pwd)/aarch64-toolchain.cmake" \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          else
            cmake "${{ github.workspace }}" \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          fi

      # =======================
      # Build
      # =======================
      - name: Build
        shell: bash
        run: |
          cd "${{ steps.vars.outputs.BUILD_DIR }}"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cmake --build . --config ${{ matrix.build_type }}
          else
            cmake --build . -- -j$(nproc)
          fi

      # =======================
      # Upload artifacts (v4)
      # =======================
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: taiwanfrp_launcher-${{ runner.os }}-${{ matrix.arch }}
          path: |
            ${{ steps.vars.outputs.BUILD_DIR }}/taiwanfrp_launcher*
            ${{ steps.vars.outputs.BUILD_DIR }}/*.exe
