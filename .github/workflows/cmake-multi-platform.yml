name: CMake Multi-Platform Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        arch: [x64, arm64]
        build_type: [Release]

    steps:
      # 1️⃣ 檢出程式碼
      - uses: actions/checkout@v4

      # 2️⃣ 設定 build 目錄變數
      - name: Set build directory
        id: vars
        run: echo "BUILD_DIR=${GITHUB_WORKSPACE}/build" >> $GITHUB_OUTPUT

      # 3️⃣ Linux 安裝依賴
      - name: Setup Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev g++-arm-linux-gnueabihf g++-aarch64-linux-gnu

      # 4️⃣ Windows 安裝 MinGW
      - name: Setup Windows MinGW
        if: runner.os == 'Windows'
        run: |
          choco install mingw -y
          echo "C:\\ProgramData\\chocolatey\\lib\\mingw\\tools\\install\\mingw64\\bin" >> $GITHUB_PATH

      # 5️⃣ CMake configure
      - name: Configure CMake
        run: |
          mkdir -p ${{ steps.vars.outputs.BUILD_DIR }}
          cd ${{ steps.vars.outputs.BUILD_DIR }}

          if [[ "${{ runner.os }}" == "Linux" && "${{ matrix.arch }}" == "arm64" ]]; then
            # Linux ARM64 交叉編譯 toolchain
            cat <<EOT > aarch64-toolchain.cmake
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR aarch64)
set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
EOT
            cmake ${{ github.workspace }} -DCMAKE_TOOLCHAIN_FILE=$(pwd)/aarch64-toolchain.cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          else
            cmake ${{ github.workspace }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          fi

      # 6️⃣ Build
      - name: Build
        run: |
          cd ${{ steps.vars.outputs.BUILD_DIR }}
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cmake --build . --config ${{ matrix.build_type }}
          else
            cmake --build . -- -j$(nproc)
          fi

      # 7️⃣ Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: myapp-${{ runner.os }}-${{ matrix.arch }}
          path: ${{ steps.vars.outputs.BUILD_DIR }}/myapp*
